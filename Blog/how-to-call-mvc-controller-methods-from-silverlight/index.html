

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" >
<head><title>
	
    
    Code Blog Foo: how-to-call-mvc-controller-methods-from-silverlight

</title><link href="../Content/base.css" rel="stylesheet" type="text/css" />
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    
    <script src="../../Scripts/shAll.js" type="text/javascript"></script>
    <link href="../../Content/SyntaxHighlighter.css" rel="stylesheet" type="text/css" />
</head>
<body>
<strong>This is an archive of blog posts from a "long time ago".  If you find this useful, let me know and I'll revive it.</strong>
    <div class="wrap">
        
        <div id="top group">
            <header>
                <h1>code blog foo - tag line bar</h1>
            </header>
            <div style="padding: 5px; border-bottom: 1px solid silver; border-top: 1px solid silver;">
                <nav>
                    <a href="/" style="margin-left: 15px; border-style: solid; border-width: 1px;">home</a>
                    <span class="sep"></span>
                    <a href="/Blog/Posts" style="margin-left: 15px; border-style: solid; border-width: 1px;">blog</a>
                    <a href="/Home/About" style="margin-left: 15px; border-style: solid; border-width: 1px;">about</a>
                    <a href="/Home/Portfolio" style="margin-left: 15px; border-style: solid; border-width: 1px;">projects/open source</a>
                </nav>
            </div>
        </div>
        
        <div class="content">
            
    
    
    <script type="text/javascript">
        window.onload = function () {
            SyntaxHighlighter.config.clipboardSwf = '/Scripts/clipboard.swf';
            SyntaxHighlighter.all();
            dp.SyntaxHighlighter.HighlightAll('code');
        };

     </script>
    <h2>Calling ASP.NET MVC 2.0 Controller Methods from Silverlight</h2>

<a href="http://github.com/amirrajan/restful-silverlight">source code to RestFacilitator and AsyncDelegation</a>

<h3>Here we go...Prerequisite</h3>
<p>
   ASP.NET MVC is extremely powerful (to say the least).  In a previous blog post, I talked about <a href="integrating-silverlight-into-aspmvc">how to "seamlessly" integrate Silverlight and ASP.NET MVC</a>.  The blog post helped set the mental stage for communicating asynchronously with ASP.NET MVC via jQuery and then showed that same communication approach with Silverlight (so be sure to read that blog post).
</p>

<h3>Setting the Stage</h3>
<p>
   This whole endeavor started with a simple question: <strong>Why can I communicate with ASP.NET MVC via client side javascript, and yet can't find any documentation on doing the same thing via Silverlight?</strong>  Well here is the code to do that (<strong>again, it may be a good idea to read the blog post provided in the prerequisite</strong>): 
</p>

<p>
Here is the code for a RestFacilitator class I've created to call HTTP/GET and HTTP/POST controller actions: (source code download link is at the top of this post)
</p>

<pre name="code" class="c#">
public class RestFacilitator
{
    private SynchronizationContext _synchronizationContext;
    public RestFacilitator(SynchronizationContext synchronizationContext)
    {
        _synchronizationContext = synchronizationContext;
    }

    public void Post(string resource, Dictionary&lt;string, string&gt; parameters, 
                     SendOrPostCallback onComplete)
    {
        string uriPath = resource;
        Uri uri = new Uri(uriPath, UriKind.Absolute);
        HttpWebRequest httpWebRequest = 
            (HttpWebRequest)WebRequest.Create(uri);
            
        httpWebRequest.Method = "POST";

        AsyncCallback readResponse = null;
        AsyncCallback writeRequest = null;

        writeRequest = new AsyncCallback(
            (e) =&gt;
            {
                httpWebRequest.ContentType = 
                    "application/x-www-form-urlencoded";
                    
                Stream stream = httpWebRequest.EndGetRequestStream(e);
                string postData = string.Empty;

                foreach (string key in parameters.Keys)
                {
                    postData += key + "=" + parameters[key] + "&";
                }

                StreamWriter streamWriter = new StreamWriter(stream);
                streamWriter.Write(postData);
                streamWriter.Close();
                stream.Close();
                httpWebRequest.BeginGetResponse(readResponse, null);
            });

        readResponse = new AsyncCallback(
            (e) =&gt;
            {
                _synchronizationContext.Post(onComplete, null);
            });

        //go statement
        httpWebRequest.BeginGetRequestStream(writeRequest, null);
    }

    public void Get&lt;T&gt;(string resource, SendOrPostCallback onComplete) 
        where T : class, new()
    {
        string uriPath = resource;
        Uri uri = new Uri(uriPath, UriKind.Absolute);
        HttpWebRequest httpWebRequest = 
            (HttpWebRequest)WebRequest.Create(uri);

        AsyncCallback done =
            new AsyncCallback(
                (e) =&gt;
                {
                    HttpWebRequest request = 
                        (HttpWebRequest)e.AsyncState;
                    HttpWebResponse response = 
                        (HttpWebResponse)request.EndGetResponse(e);

                    Stream stream = response.GetResponseStream();
                    DataContractJsonSerializer dataContractJsonSerializer = 
                        new DataContractJsonSerializer(typeof(T));

                    T result = new T();
                    result = 
                        dataContractJsonSerializer.ReadObject(stream) as T;
                    _synchronizationContext.Post(onComplete, result);

                });

        //go statement
        httpWebRequest.BeginGetResponse(done, httpWebRequest);
    }}
</pre>

<p>
  With the code above, you can call an ASP.NET MVC controller action from Silverlight (which is awesome...cause then you don't have to use WCF). Have I mentioned that it would be a good idea to read the blog post in the prerequisite?  Cause this is where things get interesting....
</p>

<h3>Call WCF from Silverlight or call MVC Controllers from Silverlight?</h3>
<p>
   Now that you have the RestFacilitator, <strong>you can use MVC Controllers as restful services</strong>.  So is this better than using WCF?  You decide.  Lets take a "Calculator Service" and see how we would implement it in both WCF and ASP.NET MVC:
</p>

<h3>Calculator Service in WCF</h3>
<p>
   Here is the data and service contract:
</p>
<pre name="code" class="c#">
[ServiceContract]
public interface ICalculator
{
    [OperationContract]
    IntResult Add(int x, int y);

    [OperationContract]
    IntResult Subtract(int x, int y);

    [OperationContract]
    IntResult Multiply(int x, int y);
}

[DataContract]
public class IntResult
{
    [DataMember]
    public int Value { get; set; }
}
</pre>

<p>
And here is the concrete implementation of the WCF service: 
</p>

<pre name="code" class="c#">
public class Calculator : ICalculator
{
    IntResult ICalculator.Add(int x, int y)
    {
        return new IntResult { Value = x + y };
    }

    IntResult ICalculator.Subtract(int x, int y)
    {
        return new IntResult { Value = x - y };
    }

    IntResult ICalculator.Multiply(int x, int y)
    {
        return new IntResult { Value = x * y };
    }
}
</pre>
<h3>Calculator Service in ASP.NET MVC</h3>
<p>
   Here is the implementation of the "Calculator Service" in ASP.NET MVC:
</p>
<pre name="code" class="c#">
public class IntResult
{
    public int Value { get; set; }
}

public class CalculatorController : Controller
{
    [HttpGet]
    public ActionResult Add(int x, int y)
    {
        return Json(new IntResult { Value = x + y }, JsonRequestBehavior.AllowGet);
    }

    [HttpGet]
    public ActionResult Subtract(int x, int y)
    {
        return Json(new IntResult { Value = x - y }, JsonRequestBehavior.AllowGet);
    }

    [HttpGet]
    public ActionResult Multiply(int x, int y)
    {
        return Json(new IntResult { Value = x * y }, JsonRequestBehavior.AllowGet);
    }
}
</pre>

<h3>Service Reference in Silverlight</h3>
<p>
   <ul>
   <li>For the WCF service, you have to Right Click-&gt;"Add Service Reference...".  The service reference will be created....which happens to be 400 lines of code....yes....you read correctly....<strong>400 lines of code for the simple "Calculator Service"...</strong></li>
   <li>For the ASP.NET MVC service reference, you have to add a linked file to the IntResult class...that's it.</li>
   </ul>
</p>

<h3>Service Usage</h3>
<p>
  For this demonstration, I created a calculator application that does the follow (notice the daisy chaining that occurs):
</p>

  <ol>
     <li>The Silverlight app takes two numbers from the user and adds them.</li>
     <li>The two numbers are added, and another number is subtracted from the <strong>result</strong>.</li>
     <li>The subtraction happens, and another number is multiplied with <strong>that result</strong>.</li>
     <li>The final result (after the add, subtract and multiply) is the answer.</li>
  </ol>
<p>
   Pretty easy right?  <strong>Well the biggest hurdle is that every server side interaction in Silverlight must be asynchronous</strong>.
</p>

<p>
Here is how the daisy chaining described above would be implemented using the WCF "Calculator Service" asynchronous proxy:
</p>

<pre name="code" class="c#">
public void Calculate()
{
    CalculatorProxy.CalculatorClient client = new CalculatorProxy.CalculatorClient();

    //wire up the event for when add completes
    client.AddCompleted += (sender, e) =>
    {
        //call the subtract asynchronously
        client.SubtractAsync(e.Result.Value, Subtract);
    };

    //wire up the event for when subtract completes
    client.SubtractCompleted += (sender, e) =>
    {
        //call multiply asynchronously
        client.MultiplyAsync(e.Result.Value, Multiply);
    };

    //wire up the event for when multiply completes
    client.MultiplyCompleted += (sender, e) =>
    {
        //set the answer
        Answer = e.Result.Value;
    };

    //now all the events are wired up....Add...
    client.AddAsync(X, Y);
}
</pre>
<p>
Here is how the daisy chaining described above would be implemented using the ASP.NET MVC "Calculator Service" and the RestFacilitator:
</p>
<pre name="code" class="c#">
public void Calculate()
{
    RestFacilitator rf = new RestFacilitator();
    //call the add mvc controller action passing in X and Y
    rf.Get&lt;IntResult&gt;(
        "http://www.calculatorservice.com/add?x=" + X + "y=" + Y,
        (result) =&gt;
        {
            //when returned, call the subtract mvc controller action
            rf.Get&lt;IntResult&gt;(
                "http://www.calculatorservice.com/subtract?x=" + (result as IntResult).Value + "y=" + Subtract,
                //when returned, call the multiply mvc controller action
                (subtractResult) =&gt;
                {
                    rf.Get&lt;IntResult&gt;(
                        "http://www.calculatorservice.com/multiply?x=" + (subtractResultas IntResult).Value + "y=" + Multiply,
                        //when multiply returns, set the answer
                        (multiplyResult) =&gt;
                        {
                            Answer = (multiplyResult as IntResult).Value; 
                        });
                });
        });
}
</pre>

<h3>So far, so <strike style="color: silver;">good</strike> bad...</h3>
<p>
   Neither approach shown above is ideal...both are somewhat hard to follow (even just a simple add, subtract, then multiply).  Imagine if this was "real" code for a line of business application.  <strong>But with the RestFacilitator, I can use a fluent interface to create a nice little domain specific language that makes things more legible...a fluent interface along with the use of anonymous types (and a little bit of imagination), gives birth to AsyncDelegation</strong>.  With AsyncDelegation (another custom class), you can write the following code to accomplish the same daisy chaining:
</p>

<pre name="code" class="c#">
public void Calculate()
{
    //new up AsyncDelegation
    AsyncDelegation ad = new AsyncDelegation();

    int temp = 0;

    //Get Add
    ad.Get&lt;IntResult&gt;(
          new 
          { 
              controller = "Calculator", 
              action = "Add", 
              x = X, 
              y = Y
          })
        //when finished set the temp variable
        .WhenFinished(r =&gt; temp = r.Value)
        //then get subtract
        .ThenGet&lt;IntResult&gt;().ForRoute(
            () =&gt; 
            new
            {
                controller = "Calculator", 
                action = "Subtract", 
                x = temp, 
                y = Subtract 
            })
        //when finished set the temp variable again
        .WhenFinished(r =&gt; temp = r.Value)
        //then get multiply
        .ThenGet&lt;IntResult&gt;().ForRoute(
            () =&gt; 
            new
            {
                controller = "Calculator", 
                action = "Multiply", 
                x = temp, 
                y = Multiply
            })
        //set the answer
        .WhenFinished(r =&gt; Answer = r.Value);

    //when everything is setup, execute.
    ad.Go();
}
</pre>

<p>
    Intriguing, yes?   Well if you're interested in this approach <a href="http://github.com/amirrajan/restful">here is the source code to RestFacilitator and AsyncDelegation</a> (please keep in mind this is a work in progress).  Constructive feedback is always welcome.
</p>
    <hr />
    <span style="color: Silver; font-size: small;">Written: 6/21/2010</span>
    
    <script>
        var idcomments_acct = '6ed8d3f7f3b269a55fc308e535627d11';
        var idcomments_post_url;

        var  idcomments_post_id;// = 'http%3A%2F%2Famirrajan.net%2FBlogs%2F' + 'how-to-call-mvc-controller-methods-from-silverlight';

    </script>
    <span id="IDCommentsPostTitle" style="display:none">Comments</span>
    <script type='text/javascript' src='http://www.intensedebate.com/js/genericCommentWrapperV2.js'></script>
    <script>$("#body").append('<div></div>').html(idcomments_post_id);</script>

        </div>
    </div>
</body>
</html>

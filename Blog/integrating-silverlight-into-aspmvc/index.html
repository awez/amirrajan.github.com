

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" >
<head><title>
	
    
    Code Blog Foo: integrating-silverlight-into-aspmvc

</title><link href="../Content/base.css" rel="stylesheet" type="text/css" />
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    
    <script src="../../Scripts/shAll.js" type="text/javascript"></script>
    <link href="../../Content/SyntaxHighlighter.css" rel="stylesheet" type="text/css" />
</head>
<body>
<strong>This is an archive of blog posts from a "long time ago".  If you find this useful, let me know and I'll revive it.</strong>
    <div class="wrap">
        
        <div id="top group">
            <header>
                <h1>code blog foo - tag line bar</h1>
            </header>
            <div style="padding: 5px; border-bottom: 1px solid silver; border-top: 1px solid silver;">
                <nav>
                    <a href="/" style="margin-left: 15px; border-style: solid; border-width: 1px;">home</a>
                    <span class="sep"></span>
                    <a href="/Blog/Posts" style="margin-left: 15px; border-style: solid; border-width: 1px;">blog</a>
                    <a href="/Home/About" style="margin-left: 15px; border-style: solid; border-width: 1px;">about</a>
                    <a href="/Home/Portfolio" style="margin-left: 15px; border-style: solid; border-width: 1px;">projects/open source</a>
                </nav>
            </div>
        </div>
        
        <div class="content">
            
    
    
    <script type="text/javascript">
        window.onload = function () {
            SyntaxHighlighter.config.clipboardSwf = '/Scripts/clipboard.swf';
            SyntaxHighlighter.all();
            dp.SyntaxHighlighter.HighlightAll('code');
        };

     </script>
    <h2>Integrating Silverlight into ASP.NET MVC</h2>
    <div style="padding-left: 150px;">
        <embed style="border: solid 1px silver; padding: 5px;" src="http://blip.tv/play/AYHUuhgC" type="application/x-shockwave-flash" width="480" height="390" allowscriptaccess="always" allowfullscreen="true"></embed>
    </div>
<p>
<a href="../../Files/AsyncJavaScriptAndSilverlight.zip">click here to download source code</a>
</p>

<p>
This presentation was given at Dallas Dev Cares.  Above, is all the source code that was shown at the presentation.  This source code was written in ASP.NET MVC 1.0.  Instructions follow for upgrading this source code to ASP.NET MVC 2.0.
</p>

<h3>About the Source</h3>

<p>
This was written using the MVC 1.0 project template (I will update this to MVC 2.0 shortly).  If you have difficulty opening the project in Visual Studio, chances are you have ASP.NET MVC 2.0 installed.  Refer to this link for instructions on how to change over the project: <a href="http://www.asp.net/learn/whitepapers/aspnet-mvc2-upgrade-notes/">Convert an MVC 1.0 Project to MVC 2.0</a>.
</p>

<p>
Also in MVC 2, returning JSON via an HTTP/GET Controller action will throw an exception if you do:
</p>

<pre name="code" class="c#">
public ActionResult Search(string searchString)
{
    //populate search results
    List&lt;KeyValuePair&lt;string,string&gt;&gt; searchResults = ...;     

    //this will throw an exception in ASP.NET MVC 2
    return Json(searchResults);  
}
</pre>

<p>
 <strong>Again, the code above will throw an exception and must be changed to the following if you plan on upgrading the source code for this post to ASP.NET MVC 2:</strong>
</p>

<pre name="code" class="c#">
public ActionResult Search(string searchString)
{
    //populate search results 
    List&lt;KeyValuePair&lt;string,string&gt;&gt; searchResults = ...;     

    //this will fix the exception
    return Json(searchResults, JsonRequestBehavior.AllowGet);
}
</pre>

<h2>Here we go...</h2>

<p>
<strong>When using Silverlight, is it possible to communicate with you server without using WCF?  The answer is yes</strong>.  You can download the source code (links above) for examples on how to do this.  If you want a detailed explanation, keep reading.
</p>

<p>
To understand how we’ll go about communicating with ASP.NET MVC in Silverlight, lets start with how you can communicate with mvc through jQuery.
</p>

<h3>How to make asynchronous calls using jQuery (HTTP/GET)</h3>

<p>
<strong>First, you need to create a controller method with a NoCache attribute.</strong>
<p>

<pre name="code" class="c#">
//NoCache attribute  code
//the no cache attribute ensures that 
//the browser doesn't cache the HTTP/GET
public class NoCache : ActionFilterAttribute
{
    public override void OnActionExecuted(ActionExecutedContext filterContext)
    {
        filterContext.HttpContext
                     .Response
                     .Cache
                     .SetCacheability(HttpCacheability.NoCache);
    }
}
 

//Controller Action
AcceptVerbs(HttpVerbs.Get)
ActionName("People")
NoCache 
public JsonResult People()
{
    List&lt;Person&gt; person = new List&lt;Person&gt;();
    person.Add(new Person { FirstName = "John", LastName = "Doe" });
    person.Add(new Person { FirstName = "Jane", LastName = "Doe" });

    //if you are using MVC 1.0 you would do this:
    return Json(person);
   
    //if you are using MVC 2.0 you would do this:
    return Json(searchResults, JsonRequestBehavior.AllowGet);
}
</pre>
 
<p>
<strong>Second, create a view that will call the controller action using jQuery’s $.getJSON method.</strong>
</p>

<pre name="code" class="html">
&lt;%@ Page Language="C#" Inherits="System.Web.Mvc.ViewPage" %&gt;

&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"&gt;

&lt;html xmlns="http://www.w3.org/1999/xhtml" &gt;
    &lt;head id="Head1" runat="server"&gt;
        &lt;title&gt;Index&lt;/title&gt;
        &lt;script src="&lt;%= Url.Content("~/scripts/jquery-1.3.2.js") %&gt;" 
                   type="text/javascript"&gt;&lt;/script&gt;
    &lt;/head&gt;
    &lt;body&gt;
        
        &lt;% 
            string getPeopleUrl = 
                Url.RouteUrl(new { controller = "Home", 
                    action = "People" }); 
                    //Create your mvc url for the controller method
        %&gt;
        
        &lt;script type="text/javascript"&gt;
            $(InitializeComponents);
            
            function InitializeComponents() {
                //wire up the click for the async button
                $('#buttonGetPeople').click(function() { GetPeople(); }); 
            }

            function GetPeople() {
                //call $.getJSON giving the controller method
                $.getJSON('&lt;%= getPeopleUrl %&gt;', 
                //PopulatePeople will be called with the async call returns
                PopulatePeople); 
            }

            function PopulatePeople(data) { 
                //data is the JSON serialization of List&lt;People&gt;
                for (i = 0; i &lt; data.length; i++) {
                    //enumerate the list and put in alert boxes
                    alert(datai.FirstName + ' ' + datai.LastName); 
                }
            }
        &lt;/script&gt;
        
        &lt;input id="buttonGetPeople" type="button" value="get async" /&gt;
    &lt;/body&gt;
&lt;/html&gt;
</pre>

<h3>
How to make asynchronous calls using jQuery (HTTP/POST)
</h3>

<p>
<strong>First, you need to create a controller method.</strong>
</p>

<pre name="code" class="c#">
AcceptVerbs(HttpVerbs.Post) 
ActionName("People") 
public EmptyResult People(string firstName, string lastName) 
{ 
    //enter "Save" code here... 
    return new EmptyResult(); 
}
</pre>
 
<p>
<strong>Second, create a view that will call the controller action using jQuery’s $.post method.</strong>
</p>

<pre name="code" class="html">
&lt;%@ Page Language="C#" Inherits="System.Web.Mvc.ViewPage" %&gt;

&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"&gt;

&lt;html xmlns="http://www.w3.org/1999/xhtml" &gt;
    &lt;head id="Head1" runat="server"&gt;
        &lt;title&gt;Index&lt;/title&gt;
        &lt;script src="&lt;%= Url.Content("~/scripts/jquery-1.3.2.js") %&gt;" 
                   type="text/javascript"&gt;&lt;/script&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;% 
            string savePersonUrl = 
                Url.RouteUrl(new { controller = "Home", 
                    action = "People" }); 
                    //create your mvc url for the controller action
        %&gt;
        
        &lt;script type="text/javascript"&gt;
            function InitializeComponents() {
                //wire up the click for the async button
                $('#buttonSavePerson').click(function() { SavePerson(); }); 
            }

            function SavePerson() {
                //pull out the value from textboxes
                var firstNameFromTextBox = $('#textBoxFirstName').val(); 
                var lastNameFromTextBox = $('#textBoxLastName').val();
                
                //call controller action asynchronously
                $.post('&lt;%= savePersonUrl %&gt;',
                        { 
                          firstName: firstNameFromTextBox, 
                          lastName: lastNameFromTextBox 
                        }, 
                        function() { alert('saved'); });
            }

           
            $(InitializeComponents);
        &lt;/script&gt;
        
        First Name: &lt;input id="textBoxFirstName" type="text" value="" /&gt;&lt;br /&gt;
        Last Name: &lt;input id="textBoxLastName" type="text" value="" /&gt;&lt;br /&gt;
        &lt;input id="buttonSavePerson" type="button" value="save" /&gt;
    &lt;/body&gt;
&lt;/html&gt;
</pre>

<h3>How to communicate with mvc controllers in Silverlight</h3>

<p>
Some things to keep in mind:
</p>
<img src="../../Content/images/goodideabadidea.JPG" />
<ol>
    <li>Download the sample code located at the top of this post for detailed example.</li>
    <li>Don’t rely on data existing in the session when communicating from Silverlight.</li>
    <li>You can’t entirely guarantee that the session will be authenticated, so you cannot use the Authorize attribute on your controller actions that are leveraged by Silverlight (consider passing in an authentication token/guid with every call).</li>
    <li>To share strongly typed classes (.cs files) between Silverlight and ASP.NET MVC, use linked files.  There is no WSDL since we aren’t using WCF, so linked classes/files is the solution for creating fidelity between your mvc application and your Silverlight application.</li>
    <li>This technique for communication is about <strong>integrating</strong> Silverlight into and ASP.NET MVC website.  Silverlight acts as a powerful component of the web solution.  I would not recommend this approach to server side communication if your application is 100% Silverlight with no ASP.MVC pages.</li>
    <li>Is this best practices?  To be honest I can’t say if it is/isn’t.  “Best practices” recommends using WCF for Silverlight communication.  Don’t get me wrong, WCF is an amazing platform with complex data bindings and amazing support for a Service Oriented Architecture.  But, given that the only thing I need is an intermediary between my Silverlight client and the server, WCF becomes an added complexity that I get no benefit from…I am not trying to go for an SOA solution…I just want to be able to communicate with my server side assets.  So…just keep it simple and don’t use WCF.</li>
</ol>

<p>
<strong>So how do you communicate with your server side assets from Silverlight with out using WCF?</strong>
<br/>
<br/>
Answer: You have to simulate the HTTP/GET and HTTP/POST using Silverlight’s System.Net.HttpWebRequest.  The HTTP calls map to ASP.NET MVC controllers that return JSON serialized object which are reconstituted on the Silverlight Client.<br/>
<br/>
<br/>
<strong>
Using the RestFacilitator (custom created class), you can call directly into your ASP.NET MVC controllers (example below):
</strong>
<br/>
<br/>
</p>

<pre name="code" class="c#">
public void SavePerson(string firstName, string lastName)
{
    Dictionary&lt;string, string&gt; parameters = new Dictionary&lt;string, string&gt;();
    parameters.Add("firstName", firstName);
    parameters.Add("lastName", lastName);

    _restFacilitator.Post("http://localhost:50400/Home/People",
    parameters,
    (e) =&gt; _view.NotifySaveSuccessful());
}

public void GetPeople()
{
    _restFacilitator.Get&lt;List&lt;Person&gt;&gt;(
    "http://localhost:50400/Home/People",
    (result) =&gt;
    {
        List&lt;Person&gt; resultAsPerson = result as List&lt;Person&gt;;
        _view.PopulatePeople(resultAsPerson);
    });
}
</pre>
 
<p>
<strong>Here is the code for a RestFacilitator class I’ve created to do both the HTTP/GET and HTTP/POST: (source code download link is at the top of this post)</strong>
</p>

<pre name="code" class="c#">
public class RestFacilitator
{
    private SynchronizationContext _synchronizationContext;
    public RestFacilitator(SynchronizationContext synchronizationContext)
    {
        _synchronizationContext = synchronizationContext;
    }

    public void Post(string resource, Dictionary&lt;string, string&gt; parameters, 
                     SendOrPostCallback onComplete)
    {
        string uriPath = resource;
        Uri uri = new Uri(uriPath, UriKind.Absolute);
        HttpWebRequest httpWebRequest = 
            (HttpWebRequest)WebRequest.Create(uri);
            
        httpWebRequest.Method = "POST";

        AsyncCallback readResponse = null;
        AsyncCallback writeRequest = null;

        writeRequest = new AsyncCallback(
            (e) =&gt;
            {
                httpWebRequest.ContentType = 
                    "application/x-www-form-urlencoded";
                    
                Stream stream = httpWebRequest.EndGetRequestStream(e);
                string postData = string.Empty;

                foreach (string key in parameters.Keys)
                {
                    postData += key + "=" + parameterskey + "&";
                }

                StreamWriter streamWriter = new StreamWriter(stream);
                streamWriter.Write(postData);
                streamWriter.Close();
                stream.Close();
                httpWebRequest.BeginGetResponse(readResponse, null);
            });

        readResponse = new AsyncCallback(
            (e) =&gt;
            {
                _synchronizationContext.Post(onComplete, null);
            });

        //go statement
        httpWebRequest.BeginGetRequestStream(writeRequest, null);
    }

    public void Get&lt;T&gt;(string resource, SendOrPostCallback onComplete) 
        where T : class, new()
    {
        string uriPath = resource;
        Uri uri = new Uri(uriPath, UriKind.Absolute);
        HttpWebRequest httpWebRequest = 
            (HttpWebRequest)WebRequest.Create(uri);

        AsyncCallback done =
            new AsyncCallback(
                (e) =&gt;
                {
                    HttpWebRequest request = 
                        (HttpWebRequest)e.AsyncState;
                    HttpWebResponse response = 
                        (HttpWebResponse)request.EndGetResponse(e);

                    Stream stream = response.GetResponseStream();
                    DataContractJsonSerializer dataContractJsonSerializer = 
                        new DataContractJsonSerializer(typeof(T));

                    T result = new T();
                    result = 
                        dataContractJsonSerializer.ReadObject(stream) as T;
                    _synchronizationContext.Post(onComplete, result);

                });

        //go statement
        httpWebRequest.BeginGetResponse(done, httpWebRequest);
    }}
</pre>
    <hr />
    <span style="color: Silver; font-size: small;">Written: 3/25/2010</span>
    
    <script>
        var idcomments_acct = '6ed8d3f7f3b269a55fc308e535627d11';
        var idcomments_post_url;

        var  idcomments_post_id;// = 'http%3A%2F%2Famirrajan.net%2FBlogs%2F' + 'integrating-silverlight-into-aspmvc';

    </script>
    <span id="IDCommentsPostTitle" style="display:none">Comments</span>
    <script type='text/javascript' src='http://www.intensedebate.com/js/genericCommentWrapperV2.js'></script>
    <script>$("#body").append('<div></div>').html(idcomments_post_id);</script>

        </div>
    </div>
</body>
</html>

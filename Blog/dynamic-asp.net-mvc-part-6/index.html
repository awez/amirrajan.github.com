

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" >
<head><title>
	
    
    Code Blog Foo: dynamic-asp.net-mvc-part-6

</title><link href="../Content/base.css" rel="stylesheet" type="text/css" />
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    
    <script src="../../Scripts/shAll.js" type="text/javascript"></script>
    <link href="../../Content/SyntaxHighlighter.css" rel="stylesheet" type="text/css" />
</head>
<body>
<strong>This is an archive of blog posts from a "long time ago".  If you find this useful, let me know and I'll revive it.</strong>
    <div class="wrap">
        
        <div id="top group">
            <header>
                <h1>code blog foo - tag line bar</h1>
            </header>
            <div style="padding: 5px; border-bottom: 1px solid silver; border-top: 1px solid silver;">
                <nav>
                    <a href="/" style="margin-left: 15px; border-style: solid; border-width: 1px;">home</a>
                    <span class="sep"></span>
                    <a href="/Blog/Posts" style="margin-left: 15px; border-style: solid; border-width: 1px;">blog</a>
                    <a href="/Home/About" style="margin-left: 15px; border-style: solid; border-width: 1px;">about</a>
                    <a href="/Home/Portfolio" style="margin-left: 15px; border-style: solid; border-width: 1px;">projects/open source</a>
                </nav>
            </div>
        </div>
        
        <div class="content">
            
    
    
    <script type="text/javascript">
        window.onload = function () {
            SyntaxHighlighter.config.clipboardSwf = '/Scripts/clipboard.swf';
            SyntaxHighlighter.all();
            dp.SyntaxHighlighter.HighlightAll('code');
        };

     </script>
    <h2>Dynamic ASP.NET MVC - Part 6, Mixing in Behavior</h2>

<ul>
<li>
<a href="dynamic-asp.net-mvc">TOC</a>
</li>
<li>
<a href="dynamic-asp.net-mvc-part-1">Part 1, Setting Up Your Environment</a>
</li>
<li>
<a href="dynamic-asp.net-mvc-part-2">Part 2, Creating a Better "Compiler"</a>
</li>
<li>
<a href="dynamic-asp.net-mvc-part-3">Part 3, Your First Failing Test</a>
</li>
<li>
<a href="dynamic-asp.net-mvc-part-4">Part 4, Dynamic Data Access</a>
</li>
<li>
<a href="dynamic-asp.net-mvc-part-5">Part 5, Dynamic Data to Views</a>
</li>
<li>
<a href="dynamic-asp.net-mvc-part-6">Part 6, Mixing in Behavior</a>
</li>
<li>
<a href="dynamic-asp.net-mvc-part-7">Part 7, Oak Projections in Massive</a>
</li>
</ul>


<h2>More Than Just CRUD</h2>
<p>
   Applications (at some point in time) become more that just crud applications.  Thus far, it can be argued that all we've done is take a test driven approach to a dynamic crud app.  Time to add more meat to our blog engine.
</p>

<h2>Warning, This Shit Get's Real</h2>
<p>
   This blog post is a beating.  If you are following along, make sure you're "in the zone" (caffeine helps too).  At the end of this one, you'll feel like this:
</p>

<img src="../../content/images/beaten.gif" style="margin-left: 150px; border: solid 1px silver; padding: 3px;" /> 

<blockquote> 
<a href="http://iwdrm.tumblr.com/" target="_blank">iwdrm.tumblr.com</a> 
</blockquote> 

<h2>Adding the New Blog Controller Action</h2>
<p>
    By now, I'm hoping you are familiar with specwatchr and the flow we've been following for this blog post.  So for the first part of this post, I'm going to go quickly (the approach should be familiar by now).  Let's create the New() controller action taking a test driven approach.  Fire up specwatchr follow along:
</p>
<ul>
    <li>Failing test for New() controller action:
<pre name="code" class="c#">
class describe_HomeController : nspec
{
    HomeController homeController;
    SeedController seedController;
    dynamic actionResult;
    
    void before_each()
    {
        homeController = new HomeController();
        seedController = new SeedController();
        seedController.PurgeDb();
        seedController.All();
    }

    void navigating_to_the_home_page()
    {
        act = () =&gt;
        {
            actionResult = homeController.Index();
        };

        context["given a blog with title 'Hello'"] = () =&gt;
        {
            before = () =&gt; new { Title = "Hello" }.InsertInto("Blogs");

            it["gives blogs containing a blog named 'Hello'"] = () =&gt;
            {
                var first = (actionResult.ViewBag.Blogs as IEnumerable&lt;dynamic&gt;).First();
                (first.Title as string).should_be("Hello");
            };
        };
    }
    
    //new method level context for new controller action
    void when_navigating_to_create_a_blog()
    {
        //navigate to new
        act = () =&gt; actionResult = homeController.New() as ViewResult;
    
        //it returns the view
        it["returns view"] = () =&gt;
            (actionResult as object).should_cast_to&lt;ViewResult&gt;();
    }
}
</pre>
    </li>
    <li>Make it pass:
<pre name="code" class="c#">
        public ActionResult New()
        {
            return View();
        }
</pre>
    </li>
    <li>
        Now let's add the failing tests for saving a new blog post:
<pre name="code" class="c#">
class describe_HomeController : nspec
{
    HomeController homeController;
    SeedController seedController;
    dynamic actionResult;
    string titleToSave;
    string bodyToSave;
    
    void before_each()
    {
        homeController = new HomeController();
        seedController = new SeedController();
        seedController.PurgeDb();
        seedController.All();
    }

    [other tests were here]
    
    void when_creating_new_blog()
    {
        //set the shared action result to the returned
        //value from this controller action
        act = () =&gt; 
            actionResult = homeController.New(titleToSave, bodyToSave);

        //given the blog is valid
        context["blog is valid"] = () =&gt;
        {
            before = () =&gt;
            {
                //a non empty title makes the blog valid
                //we'll specify this in a bit
                titleToSave = "some blog title";
                bodyToSave = "some body";
            };

            //ensure that after a save we are redirected
            //to the home page
            it["redirects to index after insert"] = () =&gt;
            {
                //verify the redirect result and 
                //ensure the action name is Index
                var redirectResult = 
                    (actionResult as object)
                        .should_cast_to&lt;RedirectToRouteResult&gt;();
                
                //verify action name
                redirectResult.RouteValues["action"].should_be("Index");
            };
        };
    }
}
</pre>
    </li>
    <li>
        Make it pass with a naive implementation:
<pre name="code" class="c#">
[HttpPost] //attribute added to disambiguate from New() method
public ActionResult New(string title, string body)
{
    return RedirectToAction("Index");
}
</pre>
    </li>
    <li>
        Add to the specification to force the persistence of the blog:
<pre name="code" class="c#">
class describe_HomeController : nspec
{
    HomeController homeController;
    SeedController seedController;
    dynamic actionResult;
    string titleToSave;
    string bodyToSave;
    
    void before_each()
    {
        homeController = new HomeController();
        seedController = new SeedController();
        seedController.PurgeDb();
        seedController.All();
    }

    [other tests were here]
    
    void when_creating_new_blog()
    {
        act = () =&gt; 
            actionResult = homeController.New(titleToSave, bodyToSave);

        context["blog is valid"] = () =&gt;
        {
            before = () =&gt;
            {
                titleToSave = "some blog title";
                bodyToSave = "some body";
            };

            it["redirects to index after insert"] = () =&gt;
            {
                var redirectResult = 
                    (actionResult as object)
                        .should_cast_to&lt;RedirectToRouteResult&gt;();
                
                redirectResult.RouteValues["action"].should_be("Index");
            };
            
            it["inserts blog"] = () =&gt;
            {
                //we verify the blog has been inserted
                //by requesting the index page
                var blogPosts = 
                   (homeController.Index() as ViewResult).ViewBag.Blogs;
                
                var firstBlog = 
                   (blogPosts as IEnumerable&lt;dynamic&gt;).First();
                
                (firstBlog.Title as string).should_be("some blog title");
                (firstBlog.Body as string).should_be("some body");
            };
        };
    }
}
</pre>
    </li>
    <li>Add the persistence:
<pre name="code" class="c#">
[HttpPost]
public ActionResult New(string title, string body)
{
    blogs.Insert(new
    {
        Title = title,
        Body = body
    });

    return RedirectToAction("Index");
}
</pre>
    </li>
<li>
    Update SeedController.cs to include the Body column to make the test pass:
<pre name="code" class="c#">
public string CreateBlogsTable()
{
    return Seed.CreateTable(
        "Blogs",
        new { Id = "uniqueidentifier", PrimaryKey = true },
        new { Title = "nvarchar(255)" },
        new { Body = "nvarchar(max)" } //the body column
    );
}
</pre>
</li>
    <li>Add the specification that a blog post is valid only if the title is specified:
<pre name="code" class="c#">
//declare viewBag class member for describe_HomeController
dynamic viewBag;

[..other code..]

void when_creating_new_blog()
{
    //the same act is used for valid and invalid blogs
    //specifying the before in each sub context changes
    //the parameter values before this line is executed
    //if this is confusing, go to NSpec.org and read up on some of the
    //advance concepts
    act = () =&gt; actionResult = homeController.New(titleToSave, bodyToSave);

    context["blog is valid"] = () =&gt;
    {
        //valid blog context that you implemented
    };

    //this is the invalid blog context
    context["invalid blog"] = () =&gt;
    {
        //a blog is considered invalid if title is empty
        //this will get set before the top level act
        //is executed
        before = () =&gt; titleToSave = "";

        //store the view bag value so that we can verify
        //the error.. (acts happen order
        //so the top level act executes, then this one does)
        act = () =&gt; viewBag = (actionResult as ViewResult).ViewBag;

        //verify that the "New" view is returned to the user
        //(instead of a redirect which is what would have happend
        //if the blog post was valid)
        it["returns view, giving user the opportunity to fix error"] = () =&gt;
            (actionResult as object).should_cast_to&lt;ViewResult&gt;();

        //verify that a property called Flash has been
        //set to Title Required
        it["notifies user that title is required"] = () =&gt;
            (viewBag.Flash as string).should_be("Title Required.");
    };
}
</pre>
    </li>
<li>
    Make it pass: 
<pre name="code" class="c#">
[HttpPost]
public ActionResult New(string title, string body)
{
    if (string.IsNullOrEmpty(title))
    {
        ViewBag.Flash = "Title Required.";
        return View();
    }

    blogs.Insert(new
    {
        Title = title,
        Body = body
    });

    return RedirectToAction("Index");
}
</pre>
</li>

<li>  Add the New.cshtml view:
<pre name="code" class="html">
@{
    ViewBag.Title = "New";
}

&lt;h2&gt;New&lt;/h2&gt;

@if (ViewBag.Flash != null)
{
    &lt;span&gt;Error: @ViewBag.Flash&lt;/span&gt;
}

@using (Html.BeginForm(new { action = "New" }))
{
    @Html.Label("Title")&lt;br /&gt;
    @Html.TextBox("title", "")&lt;br /&gt;
    @Html.Label("Body")&lt;br /&gt;
    @Html.TextArea("body", "")&lt;br /&gt;
    &lt;input type="submit" value="insert blog" /&gt;
}
</pre>
</li>
<li>Now that we have the ground work in place.  We can talk about mixing in behavior.</li>
</ul>

<h2>Validation of a Blog</h2>
<p>
  At this point, you should be able to insert blogs through the website by browsing to /Home/New.  Now let's look at one minor change we need to make.  If you noticed, the validation for what is considered a valid blog post in inside of the controller:
</p>
<pre name="code" class="c#">
[HttpPost]
public ActionResult New(string title, string body)
{
    if (string.IsNullOrEmpty(title)) //OMG validation in controller!!!
    {
        ViewBag.Flash = "Title required.";
        return View();
    }

    blogs.Insert(new
    {
        Title = title,
        Body = body
    });

    return RedirectToAction("Index");
}
</pre>
<p>
   Ideally, <strong>the knowledge of whether an entity is valid or not is a responsibility of the model (not the controller).  But as of right now, our blog doesn't really exist, it's just coming directly from the database as a dynamic object.</strong>  So let's "mix in" some behavior.
</p>

<h2>Red, Green, Refactor</h2>
<p>
    We've identified an opportunity to refactor.  Since we have such a good test suite we can pull out the validation inside of the controller and put it into the model:
</p>
<ul>
    <li>under the Model folder in the web app, create a class called Blog.cs (not to be confused with Blog<strong>s</strong>.cs) with the following code:
<pre name="code" class="c#">
public class Blog : Gemini
{
    //constructor takes in an immutable type
    //(anonymous types are immutable)
    public Blog(object dto)
        : base(dto)
    {
            
    }

    public bool IsValid()
    {
        //Gemini has an property exposed called _
        //this property is an dynamic object that
        //contains all the properties of the immutable type
        //Massive (with a few minor changes that have been
        //incorporated in oak) can understand how to save
        //this entity.
        return !string.IsNullOrEmpty(_.Title);
    }

    public string Validate()
    {
        if(!IsValid())
        {
            return "Title Required.";
        }

        return "";
    }
}
</pre>
    </li>
    <li>
        Update the controller to leverage the new model:
<pre name="code" class="c#">
[HttpPost]
public ActionResult New(string title, string body)
{
    //given the payload from the http request
    //create a new blog object
    var blog = new Blog(new
    {
        Title = title,
        Body = body
    });

    //if the blog is invalid,
    //then request the error
    if (!blog.IsValid())
    { 
        ViewBag.Flash = blog.Validate();
        return View();
    }

    //save the blog
    blogs.Insert(blog);

    return RedirectToAction("Index");
}
</pre>
    </li>
    <li>run <strong>rake tests</strong>...oh look, we're still green, must mean we did everything right</li>
</ul>

<h2>Gemini</h2>
<p>
Gemini is a class in oak that allows you to tack on behavior to a dynamic type.  <strong>When the need presented itself, we were able to incrementally extend the dynamic models coming from the database.</strong>  We didn't have to create a partial class or ditch the dynamic model completely and go to statically typed entities.  It's also worth noting that we can independently test Blog if we really want to (we're actually going to do that in the next part).
</p>
<p>
On an additional note, you can create a method called Save on the Blogs class.  Save() could take in the Blog type and perform the "only save if valid" orchestration (removing additional code from the controller).  It's up to you when you want to make those kinds of transitions (and you are able to because everything you have written is under test).
</p>
    <hr />
    <span style="color: Silver; font-size: small;">Written: 6/26/2011</span>
    
    <script>
        var idcomments_acct = '6ed8d3f7f3b269a55fc308e535627d11';
        var idcomments_post_url;

        var  idcomments_post_id;// = 'http%3A%2F%2Famirrajan.net%2FBlogs%2F' + 'dynamic-asp.net-mvc-part-6';

    </script>
    <span id="IDCommentsPostTitle" style="display:none">Comments</span>
    <script type='text/javascript' src='http://www.intensedebate.com/js/genericCommentWrapperV2.js'></script>
    <script>$("#body").append('<div></div>').html(idcomments_post_id);</script>

        </div>
    </div>
</body>
</html>

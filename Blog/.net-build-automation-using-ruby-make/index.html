

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" >
<head><title>
	
    
    Code Blog Foo: .net-build-automation-using-ruby-make

</title><link href="../Content/base.css" rel="stylesheet" type="text/css" />
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    
    <script src="../../Scripts/shAll.js" type="text/javascript"></script>
    <link href="../../Content/SyntaxHighlighter.css" rel="stylesheet" type="text/css" />
</head>
<body>
    <div class="wrap">
        
        <div id="top group">
            <header>
                <h1>code blog foo - tag line bar</h1>
            </header>
            <div style="padding: 5px; border-bottom: 1px solid silver; border-top: 1px solid silver;">
                <nav>
                    <a href="/" style="margin-left: 15px; border-style: solid; border-width: 1px;">home</a>
                    <span class="sep"></span>
                    <a href="/Blog/Posts" style="margin-left: 15px; border-style: solid; border-width: 1px;">blog</a>
                    <a href="/Home/About" style="margin-left: 15px; border-style: solid; border-width: 1px;">about</a>
                    <a href="/Home/Portfolio" style="margin-left: 15px; border-style: solid; border-width: 1px;">projects/open source</a>
                </nav>
            </div>
        </div>
        
        <div class="content">
            
    
    
    <script type="text/javascript">
        window.onload = function () {
            SyntaxHighlighter.config.clipboardSwf = '/Scripts/clipboard.swf';
            SyntaxHighlighter.all();
            dp.SyntaxHighlighter.HighlightAll('code');
        };

     </script>
    <script src="../../Scripts/shBrushRuby.js" type="text/javascript"></script> 

<h2>.Net Build Automation using Ruby Make (Rake)</h2>
<p>
    This is a step by step (albeit simple) guide to using RAKE for building your .Net solutions.  Before we get into how to use Rake, <strong>lets start with answering a few questions about why in the world you would want to use RAKE to build your .Net solutions</strong>.
</p>

<h3>Why use Rake?</h3>
<image src="../../Content/images/ruby-lang.png" style="float: right; margin-left: 20px; border: solid 1px silver; padding: 3px; margin-bottom: 20px;" />  
<i>Why in the world would I use Rake to build my .Net solutions?</i>

<div style="margin-left: 20px; font-weight: bold; margin-bottom: 20px;">
Cause it's cool to use Ruby!
</div>

<i>No really...I don't just want to bring in yet another programming language for the hell of it.</i>

<div style="margin-left: 20px; font-weight: bold; margin-bottom: 20px;">
Rake gives you access to Ruby's programming constructs, which have benefits over build strategies that currently exist for .Net.
</div>

<i>But I can just hit Shift+Ctrl+B in my Visual Studio IDE to build my projects.</i>

<div style="margin-left: 20px; font-weight: bold; margin-bottom: 20px;">
Having a build script does more than build the project.  It can build your project, run unit tests, deploy to staging environments, and all that other good stuff.  It also positions your code base for continuous integration.
</div>

<i>Yea, I can see how having a build script is a good idea.  But I can just use batch files to do all that stuff.</i>

<div style="margin-left: 20px; font-weight: bold; margin-bottom: 20px;">
Batch files are a good starting point, but you can't put "logic" per se in a batch file.  It can't do for-loops, if-else-branches or anything else that a programming language provides.
</div>

<i>Well if I need to have programming logic in my build automation, I can just use MSBuild scripts.  If I need to do something custom, I can just create a custom build task and add it to my build script.  All I have to do is create a new project, reference some dll's from the .Net Framework, add my .cs files, inherit from BuildTask, code it, compile, take the output assemblies and put it in a discoverable location, add the assembly dll reference in my MSbuild script with a fully qualified name, and then I can easily use the custom build task I created.  And it's nicely formatted in XML on top of that.</i>

<div style="margin-left: 20px; font-weight: bold; margin-bottom: 20px;">
You could do that I guess...or you could skip all that painful stuff and just do your custom logic in a Ruby script.  Ruby is easy enough to read when compared to XML (you don't have to deal with the all the XML noise, which can take away from what the build is actually trying to do).  Also, having the compiled assembly makes it difficult to see what the custom task is actually doing.  It is equally difficult to change it and re-deploy.
</div>

<i>What about NAnt scripts?</i>

<div style="margin-left: 20px; font-weight: bold; margin-bottom: 20px;">
Refer to previous answer.  NAnt (and MSBuild for that matter) are by no means bad solutions.  In fact, there is nothing stopping you from using all of these in conjunction.
</div>

<i>Okay so from what I gather,  Ruby Make (Rake) gives me the benefits of a batch file and at the same time gives me access to a robust programing language, but without all the overhead of having to deal with compiled assemblies and deployment.</i>
<div style="margin-left: 20px; font-weight: bold; margin-bottom: 20px;">
Correct.
</div>

<h3>Installing Rake</h3>
<p>
   Now that you are somewhat intrigued, let me get you started with Rake.  Here is a step by step guide for getting Rake installed:
</p>

<ol>
    <li><a href="http://www.ruby-lang.org/en/" target="_blank" />Download Ruby</a></li>
    <li>After installing Ruby, select "Start Command Prompt with Ruby" from the Start Menu.</li>
    <li>
        Execute the following commands in the command prompt (these commands will install Rake and supporting plugins for .Net compilations):
        <ul>
            <li>gem install rake</li>
            <li>gem install albacore</li>
            <li>gem install win32-file</li>
        <ul>
    </li>
</ol>

<p>
After Rake is installed, you can start using it.  All you need to do is:
</p>
<ol>
    <li>Create a text file called "Rakefile" (with no extension) inside of your working directory.</li>
    <li>You can then start up Command Prompt with Ruby, navigate to the working directory and run the following command: rake</li>
    <li>Ruby Make will look for a file called Rakefile, and execute its contents.</li>
</ol>

<h3>Creating a Rakefile</h3>
<p>
    Now that you have Rake installed, we can start creating a Rakefile.  
</p>

<h4>Simple Rake</h4>
<p>
   Here is really a simple Rakefile that builds a .Net solution called SampleApp.sln.  This Rakefile takes an MSBuild path, a working directory, a solution name and calls "sh" to execute the build.  When executing the rake command from command line, the task named "default" will automatically be executed. 
</p>

<pre name="code" class="ruby">

# location of the MSBuild on this computer
@msBuildPath = "#{ENV['SystemRoot']}\\Microsoft.NET\\Framework\\v4.0.30319\\msbuild.exe"

#this is how you get the working directory
@workingDirectory = pwd 

task :default do
    #shell out to msbuild giving it the solution path
    @solutionFile = "#{@workingDirectory}\\SampleApp.sln"
    sh "\"#{@msBuildPath}\" \"#{@solutionFile}\""
end

</pre>

<h4>Multiple Tasks</h4>  
<p>
   This Rakefile executes two separate tasks.  One of them builds the project and the other runs unit tests in the solution.
</p>
<pre name="code" class="ruby">

# location of the MSBuild on this computer
@msBuildPath = "#{ENV['SystemRoot']}\\Microsoft.NET\\Framework\\v4.0.30319\\msbuild.exe"
@workingDirectory = pwd #this is how you get the working directory
@msTestPath = "C:\\Program Files (x86)\\Microsoft Visual Studio 10.0\\Common7\\IDE\\mstest.exe"

#this is the default tasks that executes the other tasks
task :default =&gt; [:build, :runtests]; 

task :build do
    @solutionFile = "#{@workingDirectory}\\SampleApp.sln"
    sh "\"#{@msBuildPath}\" \"#{@solutionFile}\""
end

task :runtests do
    cd "#{@workingDirectory}\\SampleApp.UnitTests\\bin\\Debug"
    sh "\"#{@msTestPath}\" /testcontainer:SampleApp.UnitTests.dll"
end

</pre>

<h4>Composing Tasks</h4>
<p>
    This Rakefile has a task called "integration" that runs all of the default tasks and also runs integration tests.  To call the integration task, pass the task name as a command line argument, for example: "rake integration" will execute the integration task as opposed to the default task.
</p>

<pre name="code" class="ruby">

# location of the MSBuild on this computer
@msBuildPath = "#{ENV['SystemRoot']}\\Microsoft.NET\\Framework\\v4.0.30319\\msbuild.exe"
@workingDirectory = pwd #this is how you get the working directory
@msTestPath = "C:\\Program Files (x86)\\Microsoft Visual Studio 10.0\\Common7\\IDE\\mstest.exe"

task :default =&gt; [:build, :unittests];
task :integration =&gt; [:default, :integrationtests];

task :build do
    @solutionFile = "#{@workingDirectory}\\SampleApp.sln"
    sh "\"#{@msBuildPath}\" \"#{@solutionFile}\""
end

task :unittests do
    cd "#{@workingDirectory}\\SampleApp.UnitTests\\bin\\Debug"
    sh "\"#{@msTestPath}\" /testcontainer:SampleApp.UnitTests.dll"
end

task :integrationtests do
    cd "#{@workingDirectory}\\SampleApp.IntegrationTests\\bin\\Debug"
    sh "\"#{@msTestPath}\" /testcontainer:SampleApp.IntegrationTests.dll"
end

</pre>

<h4>Raising Errors</h4>
<p>
  Sometimes you want to fail the build if something doesn't go as planned.  In this example, the build will be failed if a file doesn't exist in a particular location.
</p>

<pre name="code" class="ruby">

task :default do
    @someFile = "#{@workingDirectory}\\README.txt"
    if !File.exists?(@someFile)
    	raise "#{@someFile} does not exist."
    end
end

</pre>

<h4>Using Albacore</h4>
<p>
   Albacore is a suite of Rake Build Tasks for .Net Solutions. <a href="http://www.lostechies.com/blogs/derickbailey/archive/2009/09/23/albacore-a-suite-of-rake-build-tasks-for-net-solutions.aspx" target="_blank">Los Techies has a nice little blog post on it</a>.  (The script below came from Los Techies, I've added it here for conveniance).
</p>

<pre name="code" class="ruby">
require 'albacore'
 
desc "Run a complete Albacore build sample"
task :sample =&gt; ['albacore:assemblyinfo', 'albacore:msbuild']

desc "Run a sample build using the MSBuildTask"
Rake::MSBuildTask.new(:msbuild) do |msb|
    msb.properties :configuration =&gt; :Debug
    msb.targets [:Clean, :Build]
    msb.solution = "lib/spec/support/TestSolution/TestSolution.sln"
end

desc "Run a sample assembly info generator"
Rake::AssemblyInfoTask.new(:assemblyinfo) do |asm|
    asm.version = "0.1.2.3"
    asm.company_name = "a test company"
    asm.product_name = "a product name goes here"
    asm.title = "my assembly title"
    asm.description = "this is the assembly description"
    asm.copyright = "copyright some year, by some legal entity"
    asm.custom_attributes :SomeAttribute =&gt; "some value goes here", :AnotherAttribute =&gt; "with some data"

    asm.output_file = "lib/spec/support/AssemblyInfo/AssemblyInfo.cs"
end

</pre>

<p>
Rake can do some pretty neat stuff.  Hopefully this blog post helped you get started. <a href="http://rake.rubyforge.org/" target="_blank">Here is the Rake home page</a>.
</p>
    <hr />
    <span style="color: Silver; font-size: small;">Written: 9/22/2010</span>
    
    <script>
        var idcomments_acct = '6ed8d3f7f3b269a55fc308e535627d11';
        var idcomments_post_url;

        var  idcomments_post_id;// = 'http%3A%2F%2Famirrajan.net%2FBlogs%2F' + '.net-build-automation-using-ruby-make';

    </script>
    <span id="IDCommentsPostTitle" style="display:none">Comments</span>
    <script type='text/javascript' src='http://www.intensedebate.com/js/genericCommentWrapperV2.js'></script>
    <script>$("#body").append('<div></div>').html(idcomments_post_id);</script>

        </div>
    </div>
</body>
</html>
